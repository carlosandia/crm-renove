<!DOCTYPE html>
<html>
<head>
    <title>Debug Badge Issue - Simples</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>🐛 Debug Badge Issue</h1>
    
    <div id="status">Carregando...</div>
    <div id="results"></div>

    <script>
        const { createClient } = supabase;
        
        const supabaseClient = createClient(
            'https://marajvabdwkpgopytvhh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcmFqdmFiZHdrcGdvcHl0dmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NjQwMDksImV4cCI6MjA2NTM0MDAwOX0.C_2W2u8JyApjbhqPJm1q1dFX82KoRSm3auBfE7IpmDU'
        );

        async function testQuery() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = '🔍 Testando query...';
            
            try {
                const testLeadId = 'a2059687-92e2-4bcd-a26b-4334358a5393';
                const testTenantId = 'd7caffc1-c923-47c8-9301-ca9eeff1a243';
                
                console.log('🔍 Iniciando teste com:', { testLeadId, testTenantId });
                
                // Simular exatamente a query do useLeadTasksForCard
                const { data: activities, error } = await supabaseClient
                    .from('combined_activities_view')
                    .select('*')
                    .eq('lead_id', testLeadId)
                    .eq('tenant_id', testTenantId)
                    .order('scheduled_at', { ascending: false, nullsFirst: false });
                
                if (error) {
                    statusDiv.innerHTML = '❌ Erro: ' + error.message;
                    console.error('Erro:', error);
                    return;
                }
                
                statusDiv.innerHTML = `✅ Sucesso! ${activities?.length || 0} atividades encontradas`;
                
                const stats = {
                    total: activities?.length || 0,
                    pending: activities?.filter(a => a.status === 'pending').length || 0,
                    completed: activities?.filter(a => a.status === 'completed').length || 0,
                    overdue: activities?.filter(a => a.is_overdue === true).length || 0
                };
                
                resultsDiv.innerHTML = `
                    <h2>📊 Resultado:</h2>
                    <ul>
                        <li><strong>Total:</strong> ${stats.total}</li>
                        <li><strong>Pending:</strong> ${stats.pending}</li>
                        <li><strong>Completed:</strong> ${stats.completed}</li>
                        <li><strong>Overdue:</strong> ${stats.overdue}</li>
                    </ul>
                    <h3>🎯 Badge deveria mostrar:</h3>
                    <p style="font-size: 24px; font-weight: bold; color: green;">
                        ${stats.completed}/${stats.total} = ${stats.completed}/${stats.total}
                    </p>
                    <h3>📋 Atividades:</h3>
                    <pre>${JSON.stringify(activities, null, 2)}</pre>
                `;
                
                console.log('✅ Teste concluído:', { stats, activities });
                
            } catch (error) {
                statusDiv.innerHTML = '❌ Erro de rede: ' + error.message;
                console.error('Erro de rede:', error);
            }
        }
        
        // Executar teste automaticamente
        testQuery();
    </script>
</body>
</html>