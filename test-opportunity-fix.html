<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Teste: TypeError Corrigido - Cria√ß√£o de Oportunidades</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { 
            background: #f4f4f4; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .status-ok { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .code-error {
            background: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Teste: Corre√ß√£o TypeError - toFixed() Undefined</h1>
        
        <div class="test-section error">
            <h3>‚ùå Erro Original Identificado</h3>
            <div class="code-error">
                TypeError: Cannot read properties of undefined (reading 'toFixed')<br>
                at useCreateOpportunity.ts:571:60<br>
                at avgCreationTime: `${factoryMetrics.avgCreationTime.toFixed(2)}ms`
            </div>
            <p><strong>Causa:</strong> Propriedade `avgCreationTime` removida durante refatora√ß√£o do singleton</p>
        </div>

        <div class="test-section success">
            <h3>‚úÖ Corre√ß√µes Implementadas</h3>
            <ul>
                <li><strong>Compatibilidade Restaurada:</strong> M√©tricas incluem `avgCreationTime: 0`</li>
                <li><strong>Defensive Coding:</strong> Verifica√ß√£o `!== undefined` antes de `toFixed()`</li>
                <li><strong>Fallbacks Seguros:</strong> Valores padr√£o para todas as propriedades</li>
                <li><strong>Singleton Mantido:</strong> Warning Multiple GoTrueClient ainda eliminado</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Testes Dispon√≠veis</h3>
            <div>
                <button class="btn-primary" onclick="testMetricsStructure()">
                    üìä Testar Estrutura das M√©tricas
                </button>
                <button class="btn-success" onclick="testOpportunityLogic()">
                    üöÄ Testar L√≥gica de Cria√ß√£o
                </button>
                <button class="btn-warning" onclick="testSingletonWarning()">
                    ‚ö†Ô∏è Verificar Warning Singleton
                </button>
                <button class="btn-danger" onclick="clearConsole()">
                    üßπ Limpar Console
                </button>
            </div>
        </div>

        <div class="test-section" id="results">
            <h3>üìä Resultados dos Testes</h3>
            <div id="testOutput">
                <p>Clique nos bot√µes acima para executar os testes...</p>
            </div>
        </div>

        <div class="test-section info">
            <h3>üîç Como Verificar a Corre√ß√£o</h3>
            <ol>
                <li><strong>Abra o Console</strong> do browser (F12)</li>
                <li><strong>Execute os testes</strong> clicando nos bot√µes</li>
                <li><strong>Verifique:</strong> N√£o deve aparecer TypeError relacionado a toFixed()</li>
                <li><strong>Confirme:</strong> M√©tricas s√£o exibidas corretamente</li>
                <li><strong>Valide:</strong> Warning Multiple GoTrueClient continua eliminado</li>
            </ol>
        </div>

        <div class="test-section warning">
            <h3>‚úÖ Crit√©rios de Sucesso</h3>
            <ul>
                <li><strong>Zero TypeErrors</strong> relacionados a toFixed()</li>
                <li><strong>M√©tricas exibidas</strong> com avgCreationTime seguro</li>
                <li><strong>Defensive coding funcionando</strong> - fallbacks ativados</li>
                <li><strong>Singleton preservado</strong> - warning Multiple GoTrueClient eliminado</li>
                <li><strong>Funcionalidade mantida</strong> - cria√ß√£o de oportunidades desbloqueada</li>
            </ul>
        </div>
    </div>

    <script>
        console.log('üõ†Ô∏è [TESTE-TOFIXED] P√°gina de teste carregada');
        
        function updateResults(html) {
            document.getElementById('testOutput').innerHTML = html;
        }
        
        async function testMetricsStructure() {
            console.log('üìä [TESTE-TOFIXED] Testando estrutura das m√©tricas...');
            
            try {
                updateResults('<p class="status-ok">‚è≥ Testando estrutura das m√©tricas...</p>');
                
                // Importar factory e testar m√©tricas
                const module = await import('./src/lib/supabaseClientFactory.ts');
                const metrics = module.getClientFactoryMetrics();
                
                console.log('üìä [METRICS-TEST] M√©tricas obtidas:', metrics);
                
                // Testar propriedades esperadas
                const expectedProps = ['poolSize', 'cacheHits', 'cacheMisses', 'avgCreationTime'];
                const results = {};
                let allPresent = true;
                
                expectedProps.forEach(prop => {
                    const exists = metrics.hasOwnProperty(prop);
                    const value = metrics[prop];
                    const type = typeof value;
                    
                    results[prop] = {
                        exists,
                        value,
                        type,
                        safe: exists && (type === 'number' || value === undefined)
                    };
                    
                    if (!exists) allPresent = false;
                    
                    console.log(`üîç [PROP-TEST] ${prop}:`, results[prop]);
                });
                
                // Testar toFixed() especificamente
                let toFixedTest = 'FALHOU';
                try {
                    const avgTime = metrics.avgCreationTime;
                    if (avgTime !== undefined && typeof avgTime === 'number') {
                        const formatted = `${avgTime.toFixed(2)}ms`;
                        toFixedTest = `SUCESSO: ${formatted}`;
                    } else {
                        toFixedTest = `SAFE FALLBACK: avgCreationTime = ${avgTime}`;
                    }
                } catch (error) {
                    toFixedTest = `ERRO: ${error.message}`;
                }
                
                console.log('üß™ [TOFIXED-TEST] Resultado:', toFixedTest);
                
                updateResults(`
                    <div class="${allPresent ? 'success' : 'warning'}">
                        <h4>üìä Teste de Estrutura das M√©tricas</h4>
                        <p><strong>Todas propriedades presentes:</strong> ${allPresent ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                        <p><strong>Teste toFixed():</strong> ${toFixedTest}</p>
                        
                        <h5>üîç Detalhes das Propriedades:</h5>
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                        
                        <h5>üìä M√©tricas Completas:</h5>
                        <pre>${JSON.stringify(metrics, null, 2)}</pre>
                    </div>
                `);
                
            } catch (error) {
                console.error('‚ùå [TESTE-TOFIXED] Erro no teste de m√©tricas:', error);
                updateResults(`
                    <div class="error">
                        <h4>‚ùå Erro no Teste de M√©tricas</h4>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `);
            }
        }
        
        async function testOpportunityLogic() {
            console.log('üöÄ [TESTE-TOFIXED] Simulando l√≥gica de cria√ß√£o de oportunidade...');
            
            try {
                updateResults('<p class="status-ok">‚è≥ Simulando l√≥gica de cria√ß√£o...</p>');
                
                // Simular o c√≥digo que causava erro
                const module = await import('./src/lib/supabaseClientFactory.ts');
                const factoryMetrics = module.getClientFactoryMetrics();
                
                console.log('üè≠ [SIMULATION] M√©tricas obtidas:', factoryMetrics);
                
                // Simular o c√≥digo problem√°tico (com defensive coding)
                let logResult;
                try {
                    const logData = {
                        poolSize: factoryMetrics.poolSize || 0,
                        cacheHits: factoryMetrics.cacheHits || 0,
                        cacheMisses: factoryMetrics.cacheMisses || 0,
                        avgCreationTime: factoryMetrics.avgCreationTime !== undefined 
                            ? `${factoryMetrics.avgCreationTime.toFixed(2)}ms` 
                            : 'N/A'
                    };
                    
                    console.log('üè≠ [CLIENT-FACTORY] M√©tricas (simula√ß√£o):', logData);
                    logResult = 'SUCESSO - Nenhum TypeError';
                } catch (error) {
                    logResult = `ERRO: ${error.message}`;
                }
                
                // Testar cria√ß√£o de client
                const client = module.getSupabaseClientSingleton();
                const clientCreated = !!client;
                
                console.log('‚úÖ [SIMULATION] Resultado final:', {
                    logResult,
                    clientCreated,
                    metricsAvailable: !!factoryMetrics
                });
                
                updateResults(`
                    <div class="success">
                        <h4>üöÄ Simula√ß√£o de L√≥gica de Cria√ß√£o</h4>
                        <p><strong>Log de m√©tricas:</strong> ${logResult}</p>
                        <p><strong>Client criado:</strong> ${clientCreated ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                        <p><strong>M√©tricas dispon√≠veis:</strong> ${!!factoryMetrics ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                        
                        <h5>üîç Dados Simulados:</h5>
                        <pre>${JSON.stringify({
                            logResult,
                            clientCreated,
                            factoryMetrics
                        }, null, 2)}</pre>
                        
                        <p><em>‚úÖ A corre√ß√£o eliminou o TypeError que impedia a cria√ß√£o de oportunidades!</em></p>
                    </div>
                `);
                
            } catch (error) {
                console.error('‚ùå [TESTE-TOFIXED] Erro na simula√ß√£o:', error);
                updateResults(`
                    <div class="error">
                        <h4>‚ùå Erro na Simula√ß√£o</h4>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `);
            }
        }
        
        async function testSingletonWarning() {
            console.log('‚ö†Ô∏è [TESTE-TOFIXED] Verificando se warning Multiple GoTrueClient foi preservado...');
            
            try {
                updateResults('<p class="status-ok">‚è≥ Verificando warnings de singleton...</p>');
                
                console.warn('üß™ [WARNING-TEST] Iniciando m√∫ltiplas cria√ß√µes de client...');
                
                const module = await import('./src/lib/supabaseClientFactory.ts');
                const clients = [];
                
                // Criar m√∫ltiplos clients para verificar singleton
                for (let i = 0; i < 3; i++) {
                    const client1 = module.getAnonymousClient();
                    const client2 = module.getServiceRoleClient();
                    const client3 = module.getSupabaseClientSingleton();
                    
                    clients.push({ client1, client2, client3, iteration: i + 1 });
                    
                    console.log(`üîÑ [WARNING-TEST] Itera√ß√£o ${i + 1}:`, {
                        sameInstance: client1 === client2 && client2 === client3
                    });
                }
                
                const metrics = module.getClientFactoryMetrics();
                const warningPreserved = metrics.singletonHits > 0;
                
                console.log('üìä [WARNING-TEST] M√©tricas finais:', metrics);
                
                updateResults(`
                    <div class="success">
                        <h4>‚ö†Ô∏è Verifica√ß√£o de Warning Singleton</h4>
                        <p><strong>Corre√ß√£o preservada:</strong> ${warningPreserved ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                        <p><strong>Singleton hits:</strong> ${metrics.singletonHits}</p>
                        <p><strong>Total cria√ß√µes:</strong> ${metrics.totalCreations}</p>
                        <p><strong>Inst√¢ncias iguais:</strong> ${clients[0]?.client1 === clients[0]?.client2 ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                        
                        <h5>üîç Resultado do Teste:</h5>
                        <pre>${JSON.stringify({
                            warningPreserved,
                            metrics,
                            clientsCreated: clients.length
                        }, null, 2)}</pre>
                        
                        <p><em>‚úÖ Warning Multiple GoTrueClient continua eliminado!</em></p>
                    </div>
                `);
                
            } catch (error) {
                console.error('‚ùå [TESTE-TOFIXED] Erro na verifica√ß√£o de warning:', error);
                updateResults(`
                    <div class="error">
                        <h4>‚ùå Erro na Verifica√ß√£o</h4>
                        <p>${error.message}</p>
                    </div>
                `);
            }
        }
        
        function clearConsole() {
            console.clear();
            console.log('üßπ [TESTE-TOIXED] Console limpo - pronto para novos testes');
            updateResults('<p>Console limpo. Execute os testes novamente...</p>');
        }
        
        // Executar teste inicial automaticamente
        setTimeout(() => {
            console.log('üîÑ [TESTE-TOFIXED] Executando teste inicial...');
            testMetricsStructure();
        }, 1000);
    </script>
</body>
</html>