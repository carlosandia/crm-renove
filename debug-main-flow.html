<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Main Flow</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        const { createClient } = supabase;

        // Configurar Supabase
        const supabaseClient = createClient(
            'https://marajvabdwkpgopytvhh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcmFqdmFiZHdrcGdvcHl0dmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NjQwMDksImV4cCI6MjA2NTM0MDAwOX0.C_2W2u8JyApjbhqPJm1q1dFX82KoRSm3auBfE7IpmDU'
        );

        // Context
        const AuthContext = createContext();

        // AuthProvider que simula o comportamento real
        const DebugAuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [logs, setLogs] = useState([]);

            const addLog = (message) => {
                console.log(message);
                setLogs(prev => [...prev.slice(-15), `${new Date().toLocaleTimeString()}: ${message}`]);
            };

            // Verificar sess√£o existente
            useEffect(() => {
                let mounted = true;

                const checkSession = async () => {
                    try {
                        addLog('üîÑ [AuthProvider] Verificando sess√£o...');

                        const { data: { session }, error } = await supabaseClient.auth.getSession();

                        if (error) {
                            addLog(`‚ùå [AuthProvider] Erro na sess√£o: ${error.message}`);
                            if (mounted) setLoading(false);
                            return;
                        }

                        if (session && session.user) {
                            addLog(`‚úÖ [AuthProvider] Sess√£o encontrada: ${session.user.email}`);
                            
                            // Simular busca do usu√°rio (que sabemos que funciona)
                            const mockUser = {
                                id: session.user.id,
                                email: session.user.email,
                                role: 'admin',
                                tenant_id: 'd7caffc1-c923-47c8-9301-ca9eeff1a243'
                            };
                            
                            setUser(mockUser);
                            addLog(`‚úÖ [AuthProvider] Usu√°rio configurado: ${mockUser.email} (${mockUser.role})`);
                        } else {
                            addLog('‚ÑπÔ∏è [AuthProvider] Nenhuma sess√£o encontrada');
                        }

                    } catch (error) {
                        addLog(`‚ùå [AuthProvider] Erro: ${error.message}`);
                    } finally {
                        if (mounted) {
                            addLog('üèÅ [AuthProvider] Setando loading = false');
                            setLoading(false);
                        }
                    }
                };

                checkSession();

                return () => {
                    mounted = false;
                };
            }, []);

            return (
                <AuthContext.Provider value={{ user, loading, logs }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // Hook
        const useAuth = () => useContext(AuthContext);

        // Simular LoadingFallback
        const LoadingFallback = () => (
            <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundColor: '#f9fafb' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ width: '32px', height: '32px', border: '2px solid #2563eb', borderTop: '2px solid transparent', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto' }}></div>
                    <p style={{ marginTop: '8px', fontSize: '14px', color: '#6b7280' }}>Iniciando...</p>
                </div>
            </div>
        );

        // Simular ProtectedDashboard com logs
        const ProtectedDashboard = () => {
            const { user, loading, logs } = useAuth();
            const [dashboardLogs, setDashboardLogs] = useState([]);

            const addDashboardLog = (message) => {
                console.log(message);
                setDashboardLogs(prev => [...prev.slice(-10), `${new Date().toLocaleTimeString()}: ${message}`]);
            };

            useEffect(() => {
                addDashboardLog(`üîç [ProtectedDashboard] Estado: loading=${loading}, user=${user ? user.email : 'null'}`);
                
                if (!loading && !user) {
                    addDashboardLog('üîÑ [ProtectedDashboard] Tentando redirecionar para /login...');
                    // Simular redirecionamento (n√£o executar de verdade no teste)
                    addDashboardLog('‚ö†Ô∏è [ProtectedDashboard] Redirecionamento seria executado aqui');
                }
            }, [user, loading]);

            if (loading) {
                addDashboardLog('‚è≥ [ProtectedDashboard] Mostrando LoadingFallback (loading=true)');
                return <LoadingFallback />;
            }

            if (!user) {
                addDashboardLog('üö´ [ProtectedDashboard] Mostrando LoadingFallback (user=null)');
                return <LoadingFallback />;
            }

            addDashboardLog('‚úÖ [ProtectedDashboard] Renderizando Dashboard');
            return (
                <div style={{ padding: '20px' }}>
                    <h1>üéâ Dashboard Carregado!</h1>
                    <p>Usu√°rio: {user.email} ({user.role})</p>
                    
                    <div style={{ marginTop: '20px' }}>
                        <h3>Logs do AuthProvider:</h3>
                        <div style={{ backgroundColor: '#f1f5f9', padding: '10px', borderRadius: '5px', fontSize: '12px', fontFamily: 'monospace', maxHeight: '200px', overflow: 'auto' }}>
                            {logs.map((log, index) => (
                                <div key={index}>{log}</div>
                            ))}
                        </div>
                    </div>

                    <div style={{ marginTop: '20px' }}>
                        <h3>Logs do ProtectedDashboard:</h3>
                        <div style={{ backgroundColor: '#fef3c7', padding: '10px', borderRadius: '5px', fontSize: '12px', fontFamily: 'monospace', maxHeight: '200px', overflow: 'auto' }}>
                            {dashboardLogs.map((log, index) => (
                                <div key={index}>{log}</div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // CSS para anima√ß√£o de spin
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Renderizar
        ReactDOM.render(
            <DebugAuthProvider>
                <ProtectedDashboard />
            </DebugAuthProvider>,
            document.getElementById('root')
        );
    </script>
</body>
</html>