<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Final: Multiple GoTrueClient Warning ELIMINADO</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { 
            background: #f4f4f4; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto;
            font-size: 12px;
        }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .status-ok { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Final: Corre√ß√£o Multiple GoTrueClient Warning</h1>
        
        <div class="test-section info">
            <h3>üß¨ Arquitetura Implementada</h3>
            <ul>
                <li><strong>‚úÖ Singleton √önico:</strong> UM √∫nico client Supabase</li>
                <li><strong>‚úÖ Par√¢metros Consistentes:</strong> createClient() sem configura√ß√µes customizadas</li>
                <li><strong>‚úÖ Compatibilidade Mantida:</strong> getAnonymousClient() e getServiceRoleClient() funcionam</li>
                <li><strong>‚úÖ Documenta√ß√£o Oficial:</strong> Seguindo boas pr√°ticas Supabase</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîç Testes Dispon√≠veis</h3>
            <div>
                <button class="btn-primary" onclick="testSingletonBehavior()">
                    üß™ Testar Singleton Pattern
                </button>
                <button class="btn-success" onclick="testOpportunityCreation()">
                    üöÄ Simular Cria√ß√£o de Oportunidade
                </button>
                <button class="btn-warning" onclick="showMetrics()">
                    üìä Ver M√©tricas
                </button>
                <button class="btn-danger" onclick="clearConsole()">
                    üßπ Limpar Console
                </button>
            </div>
        </div>

        <div class="test-section" id="results">
            <h3>üìä Resultados dos Testes</h3>
            <div id="testOutput">
                <p>Clique nos bot√µes acima para executar os testes...</p>
            </div>
        </div>

        <div class="test-section success">
            <h3>‚úÖ Crit√©rios de Sucesso</h3>
            <ul>
                <li><strong>Zero warnings</strong> de "Multiple GoTrueClient instances detected"</li>
                <li><strong>Singleton hits > 0</strong> ap√≥s m√∫ltiplas chamadas</li>
                <li><strong>Total creations = 1</strong> para confirmar singleton</li>
                <li><strong>Funcionalidade mantida</strong> - todas as opera√ß√µes funcionando</li>
            </ul>
        </div>

        <div class="test-section warning">
            <h3>‚ö†Ô∏è Instru√ß√µes de Uso</h3>
            <ol>
                <li>Abra o <strong>Console do Browser</strong> (F12)</li>
                <li>Clique em <strong>"Testar Singleton Pattern"</strong></li>
                <li>Observe se aparecem warnings no console</li>
                <li>Verifique as m√©tricas - devem mostrar reutiliza√ß√£o</li>
                <li>Teste cria√ß√£o de oportunidade para validar funcionalidade</li>
            </ol>
        </div>
    </div>

    <script>
        console.log('üß™ [TESTE-FINAL] P√°gina de teste carregada - preparando valida√ß√£o...');
        
        // Fun√ß√£o para atualizar resultados na p√°gina
        function updateResults(html) {
            document.getElementById('testOutput').innerHTML = html;
        }
        
        async function testSingletonBehavior() {
            console.log('üöÄ [TESTE-FINAL] Iniciando teste de singleton pattern...');
            
            try {
                updateResults('<p class="status-ok">‚è≥ Executando teste de singleton...</p>');
                
                const results = [];
                const startTime = Date.now();
                
                // Fazer m√∫ltiplas chamadas para testar singleton
                for (let i = 1; i <= 5; i++) {
                    console.log(`üîÑ [TESTE-FINAL] Chamada ${i}/5 - Obtendo client...`);
                    
                    // Importar e usar a fun√ß√£o do singleton
                    const module = await import('./src/lib/supabaseClientFactory.ts');
                    const client1 = module.getAnonymousClient();
                    const client2 = module.getServiceRoleClient();
                    const client3 = module.getSupabaseClientSingleton();
                    
                    results.push({
                        attempt: i,
                        clients: {
                            anonymous: !!client1,
                            serviceRole: !!client2,
                            singleton: !!client3,
                            sameInstance: client1 === client2 && client2 === client3
                        }
                    });
                    
                    // Pequena pausa
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                const duration = Date.now() - startTime;
                console.log('‚úÖ [TESTE-FINAL] Teste singleton conclu√≠do:', { results, duration });
                
                updateResults(`
                    <div class="success">
                        <h4>‚úÖ Teste Singleton Conclu√≠do</h4>
                        <p><strong>Duracao:</strong> ${duration}ms</p>
                        <p><strong>Chamadas realizadas:</strong> ${results.length}</p>
                        <p><strong>Inst√¢ncias iguais:</strong> ${results[0]?.clients?.sameInstance ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'}</p>
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                    </div>
                `);
                
                // Mostrar m√©tricas automaticamente
                setTimeout(showMetrics, 500);
                
            } catch (error) {
                console.error('‚ùå [TESTE-FINAL] Erro no teste:', error);
                updateResults(`
                    <div class="error">
                        <h4>‚ùå Erro no Teste</h4>
                        <p>${error.message}</p>
                    </div>
                `);
            }
        }
        
        async function testOpportunityCreation() {
            console.log('üöÄ [TESTE-FINAL] Simulando cria√ß√£o de oportunidade...');
            
            try {
                updateResults('<p class="status-ok">‚è≥ Simulando cria√ß√£o de oportunidade...</p>');
                
                // Simular dados de oportunidade
                const mockOpportunity = {
                    pipeline_id: '12345678-1234-1234-1234-123456789012',
                    stage_id: '87654321-4321-4321-4321-210987654321',
                    nome_oportunidade: 'Teste Singleton Fix',
                    valor: '10000',
                    nome_lead: 'Lead Teste',
                    email: 'teste@exemplo.com',
                    telefone: '+55 11 99999-9999',
                    lead_source: 'new_lead'
                };
                
                console.log('üìã [TESTE-FINAL] Dados mock preparados:', mockOpportunity);
                
                // Obter client e simular opera√ß√£o
                const module = await import('./src/lib/supabaseClientFactory.ts');
                const client = module.getSupabaseClientSingleton();
                
                console.log('‚úÖ [TESTE-FINAL] Client obtido com sucesso:', !!client);
                
                updateResults(`
                    <div class="success">
                        <h4>‚úÖ Simula√ß√£o de Cria√ß√£o Conclu√≠da</h4>
                        <p><strong>Client obtido:</strong> SIM ‚úÖ</p>
                        <p><strong>Dados preparados:</strong> SIM ‚úÖ</p>
                        <p><strong>Funcionalidade:</strong> MANTIDA ‚úÖ</p>
                        <pre>${JSON.stringify(mockOpportunity, null, 2)}</pre>
                        <p><em>Nota: Esta √© uma simula√ß√£o. A cria√ß√£o real requer autentica√ß√£o.</em></p>
                    </div>
                `);
                
            } catch (error) {
                console.error('‚ùå [TESTE-FINAL] Erro na simula√ß√£o:', error);
                updateResults(`
                    <div class="error">
                        <h4>‚ùå Erro na Simula√ß√£o</h4>
                        <p>${error.message}</p>
                    </div>
                `);
            }
        }
        
        async function showMetrics() {
            console.log('üìä [TESTE-FINAL] Obtendo m√©tricas...');
            
            try {
                if (window.supabaseClientFactory) {
                    const metrics = window.supabaseClientFactory.getMetrics();
                    const status = window.supabaseClientFactory.getSingletonStatus();
                    
                    console.log('üìä [M√âTRICAS-FINAL]:', { metrics, status });
                    
                    const warningFixed = status.warningFixed ? '‚úÖ SIM' : '‚ùå N√ÉO';
                    const singletonActive = status.active ? '‚úÖ ATIVO' : '‚ùå INATIVO';
                    const reuseWorking = metrics.singletonHits > 0 ? '‚úÖ FUNCIONANDO' : '‚ùå SEM REUTILIZA√á√ÉO';
                    
                    updateResults(`
                        <div class="success">
                            <h4>üìä M√©tricas do Singleton</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Warning Corrigido</strong></td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${warningFixed}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Singleton Ativo</strong></td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${singletonActive}</td>
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Reutiliza√ß√£o</strong></td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${reuseWorking}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Cria√ß√µes</strong></td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${metrics.totalCreations}</td>
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Singleton Hits</strong></td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${metrics.singletonHits}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Implementa√ß√£o</strong></td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${status.implementation}</td>
                                </tr>
                            </table>
                            
                            <h4>üîç Dados Completos:</h4>
                            <pre>${JSON.stringify({ metrics, status }, null, 2)}</pre>
                        </div>
                    `);
                } else {
                    updateResults(`
                        <div class="warning">
                            <h4>‚ö†Ô∏è Debug Interface N√£o Dispon√≠vel</h4>
                            <p>A interface de debug n√£o est√° dispon√≠vel. Certifique-se que:</p>
                            <ul>
                                <li>O frontend est√° em modo desenvolvimento</li>
                                <li>O supabaseClientFactory foi carregado</li>
                                <li>N√£o h√° erros de importa√ß√£o</li>
                            </ul>
                        </div>
                    `);
                }
            } catch (error) {
                console.error('‚ùå [TESTE-FINAL] Erro ao obter m√©tricas:', error);
                updateResults(`
                    <div class="error">
                        <h4>‚ùå Erro ao Obter M√©tricas</h4>
                        <p>${error.message}</p>
                    </div>
                `);
            }
        }
        
        function clearConsole() {
            console.clear();
            console.log('üßπ [TESTE-FINAL] Console limpo - pronto para novos testes');
            updateResults('<p>Console limpo. Execute os testes novamente...</p>');
        }
        
        // Mostrar m√©tricas iniciais ap√≥s carregamento
        setTimeout(() => {
            console.log('üîÑ [TESTE-FINAL] Carregando m√©tricas iniciais...');
            showMetrics();
        }, 2000);
    </script>
</body>
</html>