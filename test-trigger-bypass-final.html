<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Bypass de Triggers</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #e7f5e7; border-color: #28a745; }
        .error { background-color: #f8d7da; border-color: #dc3545; }
        .loading { background-color: #fff3cd; border-color: #ffc107; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow: auto; max-height: 300px; }
    </style>
</head>
<body>
    <h1>üß™ Teste Final - Sistema de Bypass de Triggers</h1>
    
    <div class="test-case">
        <h3>‚úÖ Corre√ß√µes Implementadas</h3>
        <ul>
            <li>‚úÖ Triggers corrigidos com tratamento de erro robusto</li>
            <li>‚úÖ Bypass autom√°tico para silent failures implementado</li>
            <li>‚úÖ Service role fallback configurado</li>
            <li>‚úÖ Backend API como fallback final</li>
        </ul>
    </div>

    <div class="test-case">
        <h3>üéØ Dados de Teste (Pipeline new13)</h3>
        <ul>
            <li><strong>Pipeline ID:</strong> ee4e3ea3-bfb4-48b4-8de6-85216811e5b8</li>
            <li><strong>Stage ID:</strong> 402dcb99-9e8e-4fea-bc4e-a9f62cd60a58</li>
            <li><strong>Tenant ID:</strong> d7caffc1-c923-47c8-9301-ca9eeff1a243</li>
            <li><strong>User ID:</strong> bbaf8441-23c9-44dc-9a4c-a4da787f829c</li>
        </ul>
    </div>

    <div class="test-case">
        <button onclick="testDirectSupabase()">1. Testar Supabase Direto</button>
        <button onclick="testWithBypass()">2. Testar com Bypass</button>
        <button onclick="testBackendFallback()">3. Testar Backend Fallback</button>
        <button onclick="runCompleteTest()">üöÄ Teste Completo</button>
    </div>

    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
        // Configura√ß√£o Supabase
        const supabaseUrl = 'https://marajvabdwkpgopytvhh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcmFqdmFiZHdrcGdvcHl0dmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NjQwMDksImV4cCI6MjA2NTM0MDAwOX0.C_2W2u8JyApjbhqPJm1q1dFX82KoRSm3auBfE7IpmDU';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcmFqdmFiZHdrcGdvcHl0dmhoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0OTc2NDAwOSwiZXhwIjoyMDY1MzQwMDA5fQ.mkQBVPvhM3OJndsyinoONRUHSDJMh1nFBbPPNH_6cYY';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const supabaseAdmin = window.supabase.createClient(supabaseUrl, supabaseServiceKey);

        // Dados de teste
        const testData = {
            pipeline_id: 'ee4e3ea3-bfb4-48b4-8de6-85216811e5b8',
            stage_id: '402dcb99-9e8e-4fea-bc4e-a9f62cd60a58',
            tenant_id: 'd7caffc1-c923-47c8-9301-ca9eeff1a243',
            user_id: 'bbaf8441-23c9-44dc-9a4c-a4da787f829c'
        };

        async function testDirectSupabase() {
            log('üß™ Testando Supabase cliente an√¥nimo (pode gerar silent failure)...', 'loading');
            
            try {
                const newPipelineLead = {
                    pipeline_id: testData.pipeline_id,
                    stage_id: testData.stage_id,
                    lead_master_id: null, // Deixar NULL para testar trigger
                    assigned_to: testData.user_id,
                    custom_data: {
                        nome_oportunidade: 'Teste Cliente An√¥nimo',
                        nome_lead: 'Jo√£o Cliente An√¥nimo',
                        email: 'joao.anonimo.' + Date.now() + '@exemplo.com'
                    },
                    tenant_id: testData.tenant_id,
                    created_by: testData.user_id,
                    position: 1000,
                    status: 'active',
                    lifecycle_stage: 'lead'
                };

                log('üì§ Dados enviados:', 'loading');
                log(`<pre>${JSON.stringify(newPipelineLead, null, 2)}</pre>`, 'loading');

                const { data, error } = await supabase
                    .from('pipeline_leads')
                    .insert(newPipelineLead)
                    .select('id')
                    .single();

                log('üì® Resposta do Supabase:', 'loading');
                log(`<pre>Data: ${JSON.stringify(data)}\nError: ${JSON.stringify(error)}</pre>`, 'loading');

                if (!error && !data) {
                    log('üö® SILENT FAILURE detectado! {error: null, data: null}', 'error');
                    return { silentFailure: true };
                } else if (error) {
                    log(`‚ùå Erro expl√≠cito: ${error.message}`, 'error');
                    return { error: error.message };
                } else {
                    log(`‚úÖ Sucesso! ID: ${data.id}`, 'success');
                    return { success: true, id: data.id };
                }
            } catch (error) {
                log(`‚ùå Exce√ß√£o: ${error.message}`, 'error');
                return { exception: error.message };
            }
        }

        async function testWithBypass() {
            log('üîß Testando bypass com service role...', 'loading');
            
            try {
                const newPipelineLead = {
                    pipeline_id: testData.pipeline_id,
                    stage_id: testData.stage_id,
                    lead_master_id: null,
                    assigned_to: testData.user_id,
                    custom_data: {
                        nome_oportunidade: 'Teste Bypass Service Role',
                        nome_lead: 'Jo√£o Bypass',
                        email: 'joao.bypass.' + Date.now() + '@exemplo.com'
                    },
                    tenant_id: testData.tenant_id,
                    created_by: testData.user_id,
                    position: 2000,
                    status: 'active',
                    lifecycle_stage: 'lead'
                };

                log('üì§ Testando com service role...', 'loading');

                const { data, error } = await supabaseAdmin
                    .from('pipeline_leads')
                    .insert(newPipelineLead)
                    .select('id')
                    .single();

                if (error) {
                    log(`‚ùå Service role falhou: ${error.message}`, 'error');
                    return { error: error.message };
                } else {
                    log(`‚úÖ Service role funcionou! ID: ${data.id}`, 'success');
                    return { success: true, id: data.id };
                }
            } catch (error) {
                log(`‚ùå Exce√ß√£o no bypass: ${error.message}`, 'error');
                return { exception: error.message };
            }
        }

        async function testBackendFallback() {
            log('üÜò Testando fallback via backend API...', 'loading');
            
            try {
                const response = await fetch('http://127.0.0.1:3001/api/opportunities/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token'
                    },
                    body: JSON.stringify({
                        pipeline_id: testData.pipeline_id,
                        stage_id: testData.stage_id,
                        nome_oportunidade: 'Teste Backend Fallback',
                        nome_lead: 'Jo√£o Backend',
                        email: 'joao.backend.' + Date.now() + '@exemplo.com',
                        telefone: '(11) 99999-0000',
                        lead_source: 'new_lead'
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    log(`‚ùå Backend falhou: ${result.message}`, 'error');
                    return { error: result.message };
                } else {
                    log(`‚úÖ Backend funcionou! ${result.message}`, 'success');
                    return { success: true, result };
                }
            } catch (error) {
                log(`‚ùå Erro no backend: ${error.message}`, 'error');
                return { exception: error.message };
            }
        }

        async function runCompleteTest() {
            log('üéØ Iniciando teste completo...', 'loading');
            
            const results = {
                direct: await testDirectSupabase(),
                bypass: await testWithBypass(),
                backend: await testBackendFallback()
            };
            
            log('üìä Resumo dos testes:', 'loading');
            log(`<pre>${JSON.stringify(results, null, 2)}</pre>`, 'loading');
            
            let successCount = 0;
            if (results.direct.success) successCount++;
            if (results.bypass.success) successCount++;
            if (results.backend.success) successCount++;
            
            if (successCount >= 2) {
                log(`üéâ Teste aprovado! ${successCount}/3 m√©todos funcionaram`, 'success');
            } else {
                log(`‚ö†Ô∏è Teste parcial: ${successCount}/3 m√©todos funcionaram`, 'loading');
            }
        }

        function log(message, type = 'loading') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-case ${type}`;
            div.innerHTML = `<div style="font-size: 12px; color: #666;">[${new Date().toLocaleTimeString()}]</div>${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // Auto-executar teste completo
        window.onload = () => {
            log('üöÄ Sistema de teste carregado. Clique nos bot√µes para testar.', 'success');
        };
    </script>
</body>
</html>