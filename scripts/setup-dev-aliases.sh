#!/bin/bash

# ============================================
# ‚ö° SETUP DEV ALIASES - Configura√ß√£o de Produtividade
# ============================================
# 
# ‚úÖ ESTABILIZA√á√ÉO: Script para configurar aliases √∫teis para desenvolvimento
# Cria shortcuts para comandos frequentes e melhora produtividade do desenvolvedor
# Compat√≠vel com bash e zsh
#
# Uso: ./scripts/setup-dev-aliases.sh [--install] [--uninstall] [--show]

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configura√ß√µes
PROJECT_ROOT="/Users/carlosandia/CRM-MARKETING"
ALIASES_FILE="$HOME/.crm_dev_aliases"

# Aliases para o projeto CRM
CRM_ALIASES='
# ============================================
# üöÄ CRM DEVELOPMENT ALIASES - Gerado automaticamente
# ============================================
# Aliases para melhorar produtividade no desenvolvimento CRM

# Navega√ß√£o r√°pida
alias crm="cd /Users/carlosandia/CRM-MARKETING"
alias crmback="cd /Users/carlosandia/CRM-MARKETING/backend"
alias crmscripts="cd /Users/carlosandia/CRM-MARKETING/scripts"

# Gerenciamento de servidores - comandos b√°sicos
alias start="./scripts/dev-manager.sh start"
alias stop="./scripts/dev-manager.sh stop"
alias restart="./scripts/dev-manager.sh restart"
alias status="./scripts/dev-manager.sh status"
alias clean="./scripts/dev-manager.sh clean"

# Monitoramento e debug
alias monitor="./scripts/dev-monitor.sh"
alias health="./scripts/dev-healthcheck.sh"
alias debug="./scripts/dev-manager.sh debug"
alias optimize="./scripts/dev-optimize.sh"

# Desenvolvimento r√°pido
alias dev="npm run dev"
alias devback="cd backend && npm run dev"
alias devclean="npm run dev:clean"
alias devstatus="npm run dev:status"

# Build e deploy
alias build="npm run build"
alias buildprod="npm run build:prod"
alias preview="npm run preview"

# An√°lise e qualidade
alias lint="npm run lint"
alias analyze="npm run analyze:deps"
alias typecheck="cd backend && npm run type-check && cd .. && npx tsc --noEmit"

# Git shortcuts √∫teis
alias gs="git status"
alias ga="git add"
alias gc="git commit"
alias gp="git push"
alias gl="git pull"
alias gco="git checkout"
alias gb="git branch"
alias glog="git log --oneline --graph --decorate --all -10"

# Logs r√°pidos
alias logs="tail -f frontend.log backend.log monitor.log 2>/dev/null | grep --line-buffered -E \"(ERROR|WARN|SUCCESS)\""
alias frontlog="tail -f frontend.log"
alias backlog="tail -f backend.log"
alias monlog="tail -f monitor.log"

# Utilities
alias ports="lsof -i :8080 -i :3001"
alias processes="ps aux | grep -E \"(tsx|vite|node)\" | grep -v grep"
alias killports="lsof -ti:8080,3001 | xargs kill -9 2>/dev/null || true"

# Supabase shortcuts
alias supa="npx supabase"
alias supastatus="npm run supabase:status"
alias supatable="npm run supabase:tables"

# Produtividade extrema
alias faststart="./scripts/dev-optimize.sh --force && ./scripts/dev-manager.sh start"
alias fullclean="./scripts/dev-manager.sh clean && ./scripts/dev-optimize.sh --force && npm run dev:clean"
alias quickcheck="./scripts/dev-healthcheck.sh --json | jq -r \".overall_status\""
alias autostart="./scripts/dev-manager.sh auto-restart"

# ============================================
# Fim dos aliases CRM
# ============================================
'

# Fun√ß√µes de logging
log() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}[‚úÖ]${NC} $1"
}

error() {
    echo -e "${RED}[‚ùå]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[‚ö†Ô∏è]${NC} $1"
}

info() {
    echo -e "${CYAN}[‚ÑπÔ∏è]${NC} $1"
}

# Detectar shell
detect_shell() {
    local shell_name=$(basename "$SHELL")
    case $shell_name in
        "bash")
            echo "$HOME/.bashrc"
            ;;
        "zsh")
            echo "$HOME/.zshrc"
            ;;
        *)
            echo "$HOME/.profile"
            ;;
    esac
}

# Instalar aliases
install_aliases() {
    log "üìù Instalando aliases CRM..."
    
    # Criar arquivo de aliases
    echo "$CRM_ALIASES" > "$ALIASES_FILE"
    success "Arquivo de aliases criado: $ALIASES_FILE"
    
    # Detectar arquivo de configura√ß√£o do shell
    local shell_config=$(detect_shell)
    local shell_name=$(basename "$SHELL")
    
    log "Shell detectado: $shell_name"
    log "Arquivo de configura√ß√£o: $shell_config"
    
    # Verificar se j√° est√° configurado
    if grep -q "source.*\.crm_dev_aliases" "$shell_config" 2>/dev/null; then
        warn "Aliases j√° est√£o configurados no $shell_config"
    else
        # Adicionar source no arquivo de configura√ß√£o
        echo "" >> "$shell_config"
        echo "# CRM Development Aliases" >> "$shell_config"
        echo "[ -f \"$ALIASES_FILE\" ] && source \"$ALIASES_FILE\"" >> "$shell_config"
        success "Aliases adicionados ao $shell_config"
    fi
    
    success "‚úÖ Aliases instalados com sucesso!"
    info "üí° Execute 'source $shell_config' ou abra um novo terminal para usar os aliases"
}

# Desinstalar aliases
uninstall_aliases() {
    log "üóëÔ∏è  Removendo aliases CRM..."
    
    # Remover arquivo de aliases
    if [ -f "$ALIASES_FILE" ]; then
        rm -f "$ALIASES_FILE"
        success "Arquivo de aliases removido"
    fi
    
    # Remover refer√™ncia do shell config
    local shell_config=$(detect_shell)
    if [ -f "$shell_config" ]; then
        # Usar sed para remover linhas relacionadas aos aliases CRM
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            sed -i '' '/# CRM Development Aliases/d' "$shell_config"
            sed -i '' '/\.crm_dev_aliases/d' "$shell_config"
        else
            # Linux
            sed -i '/# CRM Development Aliases/d' "$shell_config"
            sed -i '/\.crm_dev_aliases/d' "$shell_config"
        fi
        success "Refer√™ncias removidas do $shell_config"
    fi
    
    success "‚úÖ Aliases removidos com sucesso!"
    info "üí° Execute 'source $shell_config' ou abra um novo terminal para aplicar as mudan√ßas"
}

# Mostrar aliases dispon√≠veis
show_aliases() {
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${CYAN}    üöÄ CRM DEVELOPMENT ALIASES           ${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    echo -e "\n${YELLOW}üìÅ NAVEGA√á√ÉO R√ÅPIDA:${NC}"
    echo "  crm          - Ir para diret√≥rio raiz do projeto"
    echo "  crmback      - Ir para diret√≥rio backend"
    echo "  crmscripts   - Ir para diret√≥rio scripts"
    
    echo -e "\n${YELLOW}üîß GERENCIAMENTO DE SERVIDORES:${NC}"
    echo "  start        - Iniciar servi√ßos"
    echo "  stop         - Parar servi√ßos"
    echo "  restart      - Reiniciar servi√ßos"
    echo "  status       - Ver status dos servi√ßos"
    echo "  clean        - Limpeza completa"
    
    echo -e "\n${YELLOW}üìä MONITORAMENTO:${NC}"
    echo "  monitor      - Monitor em tempo real"
    echo "  health       - Verifica√ß√£o de sa√∫de"
    echo "  debug        - Diagn√≥stico completo"
    echo "  optimize     - Otimizar ambiente"
    
    echo -e "\n${YELLOW}‚ö° DESENVOLVIMENTO:${NC}"
    echo "  dev          - Iniciar frontend"
    echo "  devback      - Iniciar backend"
    echo "  devclean     - Iniciar com limpeza"
    echo "  devstatus    - Status de desenvolvimento"
    
    echo -e "\n${YELLOW}üèóÔ∏è  BUILD & DEPLOY:${NC}"
    echo "  build        - Build desenvolvimento"
    echo "  buildprod    - Build produ√ß√£o"
    echo "  preview      - Preview do build"
    
    echo -e "\n${YELLOW}üîç AN√ÅLISE & QUALIDADE:${NC}"
    echo "  lint         - Linter ESLint"
    echo "  analyze      - An√°lise de depend√™ncias"
    echo "  typecheck    - Verificar tipos TypeScript"
    
    echo -e "\n${YELLOW}üìù GIT SHORTCUTS:${NC}"
    echo "  gs           - git status"
    echo "  ga           - git add"
    echo "  gc           - git commit"
    echo "  gp           - git push"
    echo "  gl           - git pull"
    echo "  gco          - git checkout"
    echo "  gb           - git branch"
    echo "  glog         - git log (√∫ltimos 10 commits)"
    
    echo -e "\n${YELLOW}üìã LOGS:${NC}"
    echo "  logs         - Ver todos os logs (apenas erros/avisos)"
    echo "  frontlog     - Log do frontend"
    echo "  backlog      - Log do backend"
    echo "  monlog       - Log do monitor"
    
    echo -e "\n${YELLOW}üîå UTILITIES:${NC}"
    echo "  ports        - Ver portas ocupadas (8080, 3001)"
    echo "  processes    - Ver processos Node.js"
    echo "  killports    - Matar processos nas portas do projeto"
    
    echo -e "\n${YELLOW}üóÑÔ∏è  SUPABASE:${NC}"
    echo "  supa         - CLI Supabase"
    echo "  supastatus   - Status Supabase"
    echo "  supatable    - Listar tabelas"
    
    echo -e "\n${YELLOW}üöÄ PRODUTIVIDADE EXTREMA:${NC}"
    echo "  faststart    - Otimizar + iniciar"
    echo "  fullclean    - Limpeza completa + rein√≠cio"
    echo "  quickcheck   - Status r√°pido (apenas resultado)"
    echo "  autostart    - Auto-restart autom√°tico"
    
    echo -e "\n${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
}

# Verificar status dos aliases
check_status() {
    local shell_config=$(detect_shell)
    
    echo -e "${CYAN}üìã STATUS DOS ALIASES CRM${NC}"
    echo ""
    
    if [ -f "$ALIASES_FILE" ]; then
        success "Arquivo de aliases: $ALIASES_FILE ‚úÖ"
    else
        error "Arquivo de aliases: n√£o encontrado ‚ùå"
    fi
    
    if [ -f "$shell_config" ] && grep -q "source.*\.crm_dev_aliases" "$shell_config" 2>/dev/null; then
        success "Configura√ß√£o no shell: $shell_config ‚úÖ"
    else
        error "Configura√ß√£o no shell: n√£o encontrada ‚ùå"
    fi
    
    echo ""
    info "Para instalar: ./scripts/setup-dev-aliases.sh --install"
    info "Para ver todos: ./scripts/setup-dev-aliases.sh --show"
}

# Fun√ß√£o principal
main() {
    local action=${1:-"--show"}
    
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${CYAN}    ‚ö° CRM DEV ALIASES SETUP            ${NC}"
    echo -e "${CYAN}    $(date +'%Y-%m-%d %H:%M:%S')         ${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    case $action in
        "--install"|"-i")
            install_aliases
            ;;
        "--uninstall"|"-u")
            uninstall_aliases
            ;;
        "--show"|"-s")
            show_aliases
            ;;
        "--status")
            check_status
            ;;
        "--help"|"-h")
            echo "Uso: $0 [op√ß√£o]"
            echo ""
            echo "Op√ß√µes:"
            echo "  --install, -i    Instalar aliases"
            echo "  --uninstall, -u  Remover aliases"
            echo "  --show, -s       Mostrar aliases dispon√≠veis (padr√£o)"
            echo "  --status         Verificar status da instala√ß√£o"
            echo "  --help, -h       Mostrar esta ajuda"
            ;;
        *)
            error "Op√ß√£o inv√°lida: $action"
            info "Use --help para ver op√ß√µes dispon√≠veis"
            exit 1
            ;;
    esac
}

# Executar fun√ß√£o principal
main "$@"