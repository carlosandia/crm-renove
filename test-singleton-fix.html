<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Singleton Fix - Multiple GoTrueClient Warning</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üß™ Teste: Corre√ß√£o DEFINITIVA Multiple GoTrueClient Warning</h1>
    
    <div class="test-section">
        <h3>üìã Status do Teste</h3>
        <p><strong>Objetivo:</strong> Verificar se o warning "Multiple GoTrueClient instances" foi eliminado</p>
        <p><strong>Implementa√ß√£o:</strong> Singleton √∫nico seguindo documenta√ß√£o oficial Supabase</p>
        <p><strong>Corre√ß√£o:</strong> UM √∫nico client com createClient() e par√¢metros consistentes</p>
    </div>

    <div class="test-section">
        <h3>üîç Instru√ß√µes de Teste</h3>
        <ol>
            <li>Abra o console do browser (F12)</li>
            <li>Clique no bot√£o "Simular Cria√ß√£o de Oportunidade"</li>
            <li>Observe se aparecem warnings de "Multiple GoTrueClient instances"</li>
            <li>Verifique as m√©tricas do singleton</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>üß™ Controles de Teste</h3>
        <button onclick="testSingletonBehavior()">üß™ Simular Cria√ß√£o de Oportunidade</button>
        <button onclick="showMetrics()">üìä Ver M√©tricas Singleton</button>
        <button onclick="clearConsole()">üßπ Limpar Console</button>
    </div>

    <div class="test-section" id="results">
        <h3>üìä Resultados</h3>
        <div id="metricsOutput">Clique em "Ver M√©tricas Singleton" para ver os resultados...</div>
    </div>

    <div class="test-section">
        <h3>‚ö†Ô∏è O que observar no Console</h3>
        <ul>
            <li><strong>‚úÖ SUCESSO:</strong> Logs de "Singleton HIT" aparecem ap√≥s a primeira cria√ß√£o</li>
            <li><strong>‚úÖ SUCESSO:</strong> N√£o aparecem warnings de "Multiple GoTrueClient instances"</li>
            <li><strong>‚ùå FALHA:</strong> Warning "Multiple GoTrueClient instances detected..." ainda aparece</li>
            <li><strong>‚ùå FALHA:</strong> Sempre aparece "Singleton MISS" (n√£o est√° reutilizando)</li>
        </ul>
    </div>

    <script>
        console.log('üß™ [TESTE] P√°gina de teste carregada');
        
        async function testSingletonBehavior() {
            console.log('üöÄ [TESTE] Iniciando simula√ß√£o de cria√ß√£o de oportunidade...');
            
            try {
                // Simular m√∫ltiplas chamadas para verificar singleton
                const results = [];
                
                for (let i = 1; i <= 3; i++) {
                    console.log(`üîÑ [TESTE] Tentativa ${i} - Obtendo client an√¥nimo...`);
                    
                    // Importar e usar a fun√ß√£o real do singleton √∫nico
                    const module = await import('http://127.0.0.1:8080/src/lib/supabaseClientFactory.ts');
                    const client = module.getSupabaseClientSingleton();
                    
                    results.push({
                        attempt: i,
                        clientCreated: !!client,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Pequena pausa entre chamadas
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('‚úÖ [TESTE] Simula√ß√£o conclu√≠da:', results);
                
                // Mostrar m√©tricas automaticamente
                setTimeout(showMetrics, 500);
                
            } catch (error) {
                console.error('‚ùå [TESTE] Erro durante simula√ß√£o:', error);
            }
        }
        
        async function showMetrics() {
            console.log('üìä [TESTE] Obtendo m√©tricas do singleton...');
            
            try {
                if (window.supabaseClientFactory) {
                    const metrics = window.supabaseClientFactory.getMetrics();
                    const singletonStatus = window.supabaseClientFactory.getSingletonStatus();
                    
                    console.log('üìä [M√âTRICAS] Client Factory:', metrics);
                    console.log('üîç [SINGLETON STATUS]:', singletonStatus);
                    
                    // Mostrar na p√°gina tamb√©m
                    document.getElementById('metricsOutput').innerHTML = `
                        <h4>üìä M√©tricas do Client Factory:</h4>
                        <pre>${JSON.stringify(metrics, null, 2)}</pre>
                        
                        <h4>üîç Status dos Singletons:</h4>
                        <pre>${JSON.stringify(singletonStatus, null, 2)}</pre>
                        
                        <h4>‚úÖ Interpreta√ß√£o:</h4>
                        <ul>
                            <li><strong>singletonHits > 0:</strong> ${metrics.singletonHits > 0 ? '‚úÖ Reutiliza√ß√£o funcionando!' : '‚ùå Sem reutiliza√ß√£o'}</li>
                            <li><strong>totalCreations:</strong> ${metrics.totalCreations} (deve ser m√≠nimo para singleton)</li>
                            <li><strong>Singleton ativo:</strong> ${singletonStatus.active ? '‚úÖ Ativo' : '‚ùå N√£o criado'}</li>
                            <li><strong>Warning corrigido:</strong> ${singletonStatus.warningFixed ? '‚úÖ Sim' : '‚ùå N√£o'}</li>
                        </ul>
                    `;
                } else {
                    const message = '‚ö†Ô∏è window.supabaseClientFactory n√£o est√° dispon√≠vel. Certifique-se que est√° em modo de desenvolvimento.';
                    console.warn(message);
                    document.getElementById('metricsOutput').innerHTML = `<p class="warning">${message}</p>`;
                }
            } catch (error) {
                console.error('‚ùå [TESTE] Erro ao obter m√©tricas:', error);
                document.getElementById('metricsOutput').innerHTML = `<p class="error">Erro: ${error.message}</p>`;
            }
        }
        
        function clearConsole() {
            console.clear();
            console.log('üßπ [TESTE] Console limpo - pronto para novo teste');
        }
        
        // Mostrar m√©tricas iniciais
        setTimeout(showMetrics, 1000);
    </script>
</body>
</html>